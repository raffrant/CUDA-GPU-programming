#include <cusolverDn.h>
#include <cuda_runtime.h>
#include <cstdio>
#include <cstdlib>
#include <vector>

__global__ void exp_kernel(double* eigvals, int n) {
    int i = threadIdx.x;
    if (i < n) eigvals[i] = exp(eigvals[i]);
}

int main() {
    // SINGLE 4x4 TEST MATRIX (known eigenvalues for verification)
    int n = 20;
    printf("\n=== n=%d SYMMETRIC MATRIX - ALL EIGENVALUES ===\n", n);
    
    // ONE MATRIX ONLY - Tridiagonal test case
    double h_A[n*n] ={8.06737, -3.59258, 10.7743, 4.14611, 4.67164, -4.36633, 3.71024, \
2.57836, 3.28099, 3.86843, 1.01446, 1.14416, -0.630649, -2.92644, \
-3.15328, 2.61489, 8.96372, -3.65587, 9.10541, 0.147133, -3.59258, \
5.76566, 5.89472, 8.26136, 0.726617, -1.90632, 4.65176, -6.2445, \
4.67903, -4.77452, 5.62883, 3.38585, 3.6552, 13.7679, -2.73146, \
2.24485, 2.32467, 4.36097, 3.82513, -1.38495, 10.7743, 5.89472, \
13.4373, 3.72723, -4.28459, -4.06003, -1.46126, -1.52741, 7.29775, \
7.70935, 3.14184, 4.72552, -7.54493, 10.7966, 3.84134, -3.51633, \
1.99471, 5.44417, 8.74162, 1.44273, 4.14611, 8.26136, 3.72723, \
3.74793, 5.52795, 2.10091, 0.764069, -3.53018, 11.6551, -0.297587, \
-7.75788, -0.236263, 9.62975, -3.61928, 10.226, 2.15298, 4.42976, \
-0.447211, 0.943299, 5.58355, 4.67164, 0.726617, -4.28459, 5.52795, \
7.96562, -6.23448, 5.62381, 7.15151, -1.67823, 4.95267, 3.52231, \
8.37819, -2.81366, 7.93272, 9.07273, 1.88935, -1.62497, -3.17751, \
6.20704, 2.81865, -4.36633, -1.90632, -4.06003, 2.10091, -6.23448, \
-0.753098, 7.08153, -1.59101, -3.58005, 5.0297, 10.9969, -3.66384, \
4.3833, 4.1926, 1.02877, 16.544, 5.51771, 1.50411, 3.1939, 2.76542, \
3.71024, 4.65176, -1.46126, 0.764069, 5.62381, 7.08153, 6.42636, \
8.22776, 2.1672, 6.61587, -4.06549, 13.2535, 9.48416, 6.60737, \
4.45412, 5.32176, 2.6738, 5.24731, 3.30936, -0.160362, 2.57836, \
-6.2445, -1.52741, -3.53018, 7.15151, -1.59101, 8.22776, 9.52063, \
-3.32011, 2.27236, 12.0005, -0.883638, 3.44029, 0.739516, 9.7172, \
-0.0581888, 1.68002, 4.10667, -7.14734, 0.723761, 3.28099, 4.67903, \
7.29775, 11.6551, -1.67823, -3.58005, 2.1672, -3.32011, 6.06386, \
6.58684, -0.165546, 1.2739, -3.93386, 6.04441, 13.4867, -2.03415, \
-4.69691, 10.9754, -2.67476, 8.69123, 3.86843, -4.77452, 7.70935, \
-0.297587, 4.95267, 5.0297, 6.61587, 2.27236, 6.58684, -5.2493, \
-2.83779, 7.52791, 7.22952, 4.42504, -2.94428, -5.58533, 2.59698, \
-1.22889, 4.89196, -1.35155, 1.01446, 5.62883, 3.14184, -7.75788, \
3.52231, 10.9969, -4.06549, 12.0005, -0.165546, -2.83779, 7.73396, \
3.99696, -2.69717, 2.74486, 1.82772, 7.39343, 7.65907, -7.51576, \
-0.566731, 1.33314, 1.14416, 3.38585, 4.72552, -0.236263, 8.37819, \
-3.66384, 13.2535, -0.883638, 1.2739, 7.52791, 3.99696, 5.75964, \
4.93233, 6.87553, -4.40884, 2.86308, 12.2942, 11.2859, 7.91418, \
-2.08778, -0.630649, 3.6552, -7.54493, 9.62975, -2.81366, 4.3833, \
9.48416, 3.44029, -3.93386, 7.22952, -2.69717, 4.93233, -4.09826, \
9.28611, 4.36819, 6.41287, 0.65602, -1.22313, -0.994263, 8.06151, \
-2.92644, 13.7679, 10.7966, -3.61928, 7.93272, 4.1926, 6.60737, \
0.739516, 6.04441, 4.42504, 2.74486, 6.87553, 9.28611, 0.834915, \
-3.85083, 11.4777, 9.60033, 9.60462, 8.82429, 4.51297, -3.15328, \
-2.73146, 3.84134, 10.226, 9.07273, 1.02877, 4.45412, 9.7172, \
13.4867, -2.94428, 1.82772, -4.40884, 4.36819, -3.85083, 4.38864, \
2.90672, 0.0404591, 15.6737, -5.19325, 2.32951, 2.61489, 2.24485, \
-3.51633, 2.15298, 1.88935, 16.544, 5.32176, -0.0581888, -2.03415, \
-5.58533, 7.39343, 2.86308, 6.41287, 11.4777, 2.90672, 5.93625, \
9.01976, 5.45519, -1.69403, 1.04069, 8.96372, 2.32467, 1.99471, \
4.42976, -1.62497, 5.51771, 2.6738, 1.68002, -4.69691, 2.59698, \
7.65907, 12.2942, 0.65602, 9.60033, 0.0404591, 9.01976, 6.64752, \
5.43497, 0.0654165, 6.17565, -3.65587, 4.36097, 5.44417, -0.447211, \
-3.17751, 1.50411, 5.24731, 4.10667, 10.9754, -1.22889, -7.51576, \
11.2859, -1.22313, 9.60462, 15.6737, 5.45519, 5.43497, 4.8576, \
1.10403, -5.24862, 9.10541, 3.82513, 8.74162, 0.943299, 6.20704, \
3.1939, 3.30936, -7.14734, -2.67476, 4.89196, -0.566731, 7.91418, \
-0.994263, 8.82429, -5.19325, -1.69403, 0.0654165, 1.10403, 5.61207, \
9.59813, 0.147133, -1.38495, 1.44273, 5.58355, 2.81865, 2.76542, \
-0.160362, 0.723761, 8.69123, -1.35155, 1.33314, -2.08778, 8.06151, \
4.51297, 2.32951, 1.04069, 6.17565, -5.24862, 9.59813, 5.1024};
    
    printf("Matrix A =\n");
    for(int i = 0; i < n; i++) {
        for(int j = 0; j < n; j++) 
            printf("%6.1f ", h_A[i*n+j]);
        printf("\n");
    }
    
    // GPU memory
    double *d_A, *d_eigvals, *d_work;
    int *d_info;
    cudaMalloc(&d_A, n*n*sizeof(double));
    cudaMalloc(&d_eigvals, n*sizeof(double));
    cudaMalloc(&d_info, sizeof(int));
    cudaMemcpy(d_A, h_A, n*n*sizeof(double), cudaMemcpyHostToDevice);
    
    // cuSOLVER handle + workspace
    cusolverDnHandle_t handle;
    cusolverDnCreate(&handle);
    
    int lwork = 0;
    cusolverDnDsyevd_bufferSize(handle, CUSOLVER_EIG_MODE_NOVECTOR,
                               CUBLAS_FILL_MODE_LOWER, n, d_A, n, 
                               d_eigvals, &lwork);
    cudaMalloc(&d_work, lwork*sizeof(double));
    
    // COMPUTE ALL EIGENVALUES
    cusolverDnDsyevd(handle, CUSOLVER_EIG_MODE_NOVECTOR,
                    CUBLAS_FILL_MODE_LOWER, n, d_A, n, d_eigvals,
                    d_work, lwork, d_info);
    
    // CHECK + COPY ALL EIGENVALUES
    int info_h = 0;
    cudaMemcpy(&info_h, d_info, sizeof(int), cudaMemcpyDeviceToHost);
    
    std::vector<double> h_eigvals(n);
    cudaMemcpy(h_eigvals.data(), d_eigvals, n*sizeof(double), cudaMemcpyDeviceToHost);
    
    // PRINT ALL EIGENVALUES (SORTED)
    printf("\nALL EIGENVALUES (λ₁ ≤ λ₂ ≤ λ₃ ≤ λ₄):\n");
    for(int i = 0; i < n; i++) {
        printf("λ_%d = %.6f\n", i+1, h_eigvals[i]);
    }
    
    // GPU exp(λ) on ALL eigenvalues
    int threads = min(n,256);
    int blocks = (n + threads - 1) / threads;
    exp_kernel<<<blocks, threads>>>(d_eigvals, n);
    cudaDeviceSynchronize();
    
    // PRINT exp(λ) for ALL
    cudaMemcpy(h_eigvals.data(), d_eigvals, n*sizeof(double), cudaMemcpyDeviceToHost);
    printf("\nexp(λ) VALUES:\n");
    for(int i = 0; i < n; i++) {
        printf("exp(λ_%d) = %.6f\n", i+1, h_eigvals[i]);
    }
    
    // Cleanup
    cudaFree(d_A); cudaFree(d_eigvals); cudaFree(d_work); cudaFree(d_info);
    cusolverDnDestroy(handle);
    
    return 0;
}
